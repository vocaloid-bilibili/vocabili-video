<!-- public/index.html-->
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>排行榜合成控制台</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        background: #f5f5f5;
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Auth */
      #auth-overlay {
        position: fixed;
        inset: 0;
        z-index: 100;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #auth-overlay.hidden {
        display: none;
      }
      .auth-box {
        width: 320px;
        padding: 32px;
        border: 1px solid #ddd;
        background: #fff;
      }
      .auth-box h2 {
        font-size: 16px;
        font-weight: normal;
        margin-bottom: 20px;
        color: #666;
      }
      .auth-box input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        margin-bottom: 12px;
        font-size: 14px;
      }
      .auth-box input:focus {
        outline: none;
        border-color: #666;
      }
      .auth-box button {
        width: 100%;
        padding: 10px;
        background: #333;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .auth-box button:hover {
        background: #000;
      }
      .auth-error {
        color: #c00;
        font-size: 12px;
        margin-top: 8px;
        display: none;
      }
      .auth-error.show {
        display: block;
      }

      /* Header */
      header {
        background: #fff;
        border-bottom: 1px solid #ddd;
        padding: 0 20px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }
      header h1 {
        font-size: 15px;
        font-weight: 600;
      }
      .status-indicator {
        font-size: 12px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4a4;
      }

      /* Main Layout */
      main {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 16px;
        gap: 16px;
      }

      /* Panel */
      .panel {
        background: #fff;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .panel-header {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
        font-weight: 600;
        color: #333;
        background: #fafafa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }

      /* Column sizing */
      .col-files {
        width: 280px;
        flex-shrink: 0;
      }
      .col-segments {
        width: 320px;
        flex-shrink: 0;
      }
      .col-status {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* Upload */
      .upload-area {
        border: 1px dashed #ccc;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 12px;
        position: relative;
      }
      .upload-area:hover {
        border-color: #999;
        background: #fafafa;
      }
      .upload-area input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }
      .upload-area p {
        font-size: 12px;
        color: #888;
      }

      /* Buttons */
      .btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        font-size: 12px;
        color: #333;
      }
      .btn:hover {
        background: #f5f5f5;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-primary {
        background: #333;
        color: #fff;
        border-color: #333;
      }
      .btn-primary:hover {
        background: #000;
      }
      .btn-sm {
        padding: 4px 8px;
        font-size: 11px;
      }
      .btn-block {
        width: 100%;
      }

      /* File List */
      .file-item {
        border: 1px solid #eee;
        padding: 12px;
        margin-bottom: 8px;
      }
      .file-item:hover {
        border-color: #ccc;
      }
      .file-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .file-item-date {
        font-weight: 600;
        font-size: 14px;
      }
      .file-item-tag {
        font-size: 10px;
        padding: 2px 6px;
        background: #eee;
        color: #666;
      }
      .file-item-tag.ok {
        background: #d4edda;
        color: #155724;
      }
      .file-item-tag.warn {
        background: #fff3cd;
        color: #856404;
      }
      .file-item-actions {
        display: flex;
        gap: 6px;
      }
      .file-item-actions .btn {
        flex: 1;
      }
      .file-item-download {
        display: block;
        text-align: center;
        font-size: 11px;
        color: #666;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #eee;
        text-decoration: none;
      }
      .file-item-download:hover {
        color: #333;
      }

      /* Segment List */
      .segment-controls {
        margin-bottom: 12px;
      }
      .segment-controls select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        font-size: 13px;
        margin-bottom: 8px;
      }
      .segment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 12px;
      }
      .segment-item:hover {
        background: #fafafa;
      }
      .segment-name {
        font-family: Consolas, monospace;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        margin-right: 8px;
      }
      .segment-actions {
        display: flex;
        gap: 4px;
        opacity: 0.5;
      }
      .segment-item:hover .segment-actions {
        opacity: 1;
      }
      .segment-actions a,
      .segment-actions button {
        padding: 4px;
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        font-size: 11px;
        text-decoration: none;
      }
      .segment-actions a:hover,
      .segment-actions button:hover {
        color: #000;
      }

      /* Status Card */
      .status-card {
        padding: 20px;
        flex-shrink: 0;
      }
      .status-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }
      .status-title {
        font-size: 18px;
        font-weight: 600;
      }
      .status-desc {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }
      .status-badge {
        font-size: 10px;
        padding: 4px 8px;
        background: #eee;
        color: #666;
        font-weight: 600;
      }
      .status-badge.running {
        background: #cce5ff;
        color: #004085;
      }
      .status-badge.done {
        background: #d4edda;
        color: #155724;
      }
      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
      }
      .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
      }
      .progress-bar {
        height: 6px;
        background: #eee;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: #333;
        width: 0%;
        transition: width 0.3s;
      }

      /* Log Terminal */
      .terminal {
        flex: 1;
        background: #1a1a1a;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .terminal-header {
        padding: 8px 12px;
        background: #252525;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .terminal-header span {
        font-size: 11px;
        color: #888;
        font-family: Consolas, monospace;
      }
      .terminal-header button {
        background: none;
        border: none;
        color: #666;
        font-size: 10px;
        cursor: pointer;
        text-transform: uppercase;
      }
      .terminal-header button:hover {
        color: #fff;
      }
      .terminal-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        font-family: Consolas, Monaco, monospace;
        font-size: 11px;
        line-height: 1.6;
        color: #ccc;
      }
      .terminal-body::-webkit-scrollbar {
        width: 6px;
      }
      .terminal-body::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      .terminal-body::-webkit-scrollbar-thumb {
        background: #444;
      }
      .log-line {
        margin-bottom: 2px;
      }
      .log-time {
        color: #666;
        margin-right: 8px;
      }
      .log-error {
        color: #f66;
      }
      .log-success {
        color: #6c6;
      }
      .log-skip {
        color: #cc6;
      }
      .log-info {
        color: #6cf;
      }

      /* Dialog */
      dialog {
        border: 1px solid #ddd;
        padding: 0;
        max-width: 360px;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.3);
      }
      .dialog-content {
        padding: 20px;
      }
      .dialog-content h3 {
        font-size: 14px;
        margin-bottom: 12px;
      }
      .dialog-content p {
        font-size: 12px;
        color: #666;
        margin-bottom: 16px;
      }
      .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      /* Empty state */
      .empty {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 12px;
      }

      /* Icon buttons */
      .icon-btn {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .icon-btn:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- Auth -->
    <div id="auth-overlay">
      <div class="auth-box">
        <h2>输入访问密钥</h2>
        <input type="password" id="apiKeyInput" placeholder="Access Key" />
        <button onclick="attemptLogin()">进入</button>
        <p class="auth-error" id="authError">密钥错误</p>
      </div>
    </div>

    <!-- Header -->
    <header>
      <h1>排行榜合成控制台</h1>
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>在线</span>
      </div>
    </header>

    <!-- Main -->
    <main>
      <!-- Files Column -->
      <div class="col-files panel">
        <div class="panel-header">
          <span>数据文件</span>
          <button class="icon-btn" onclick="loadFiles()" title="刷新">↻</button>
        </div>
        <div class="panel-body">
          <!-- Upload -->
          <div class="upload-area">
            <input type="file" id="fileInput" multiple accept=".json" />
            <p>点击或拖拽 JSON 文件</p>
          </div>
          <button
            class="btn btn-primary btn-block"
            onclick="uploadFiles()"
            id="uploadBtn"
          >
            上传
          </button>

          <div
            style="
              margin-top: 16px;
              border-top: 1px solid #eee;
              padding-top: 12px;
            "
          >
            <div id="fileList"><div class="empty">加载中...</div></div>
          </div>
        </div>
      </div>

      <!-- Segments Column -->
      <div class="col-segments panel">
        <div class="panel-header">
          <span>分片管理</span>
        </div>
        <div class="panel-body">
          <div class="segment-controls">
            <select id="segmentDateSelect" onchange="loadSegments()">
              <option value="">选择日期</option>
            </select>
            <div style="position: relative">
              <input
                type="file"
                id="segUploadInput"
                accept=".mp4"
                style="
                  position: absolute;
                  inset: 0;
                  opacity: 0;
                  cursor: pointer;
                "
              />
              <button class="btn btn-block btn-sm">上传替换分片</button>
            </div>
          </div>
          <div id="segmentList"><div class="empty">请选择日期</div></div>
        </div>
      </div>

      <!-- Status Column -->
      <div class="col-status">
        <!-- Status Card -->
        <div class="panel status-card">
          <div class="status-card-header">
            <div>
              <div class="status-title" id="statusTitle">空闲</div>
              <div class="status-desc" id="statusDesc">等待任务</div>
            </div>
            <div class="status-badge" id="statusBadge">IDLE</div>
          </div>
          <div class="progress-info">
            <span id="stepText">无任务</span>
            <span id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
          </div>
        </div>

        <!-- Terminal -->
        <div class="panel terminal">
          <div class="terminal-header">
            <span>LOG</span>
            <button onclick="clearLogs()">清空</button>
          </div>
          <div class="terminal-body" id="logContainer">
            <div style="color: #666">等待输出...</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Dialog -->
    <dialog id="repairDialog">
      <div class="dialog-content">
        <h3>重新渲染分片</h3>
        <p id="repairTarget">目标: 未选择</p>
        <div class="dialog-actions">
          <button
            class="btn"
            onclick="document.getElementById('repairDialog').close()"
          >
            取消
          </button>
          <button class="btn btn-primary" onclick="confirmRepair()">
            确认
          </button>
        </div>
      </div>
    </dialog>

    <script>
      const API = "/api";
      let API_KEY = localStorage.getItem("omo_api_key") || "";
      let selectedDate = "";
      let repairTargetFile = null;
      let pollingInterval = null;

      // Auth
      function attemptLogin() {
        const key = document.getElementById("apiKeyInput").value.trim();
        if (!key) return;
        API_KEY = key;
        localStorage.setItem("omo_api_key", key);
        checkAuth();
      }

      async function checkAuth() {
        try {
          const res = await fetchWithAuth(`${API}/files`);
          if (res.status === 401) throw new Error("401");
          document.getElementById("auth-overlay").classList.add("hidden");
          initApp();
        } catch (e) {
          document.getElementById("authError").classList.add("show");
          localStorage.removeItem("omo_api_key");
        }
      }

      async function fetchWithAuth(url, opts = {}) {
        opts.headers = opts.headers || {};
        opts.headers["x-api-key"] = API_KEY;
        return fetch(url, opts);
      }

      // Init
      document.addEventListener("DOMContentLoaded", () => {
        if (API_KEY) checkAuth();

        document
          .getElementById("apiKeyInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") attemptLogin();
          });

        document
          .getElementById("segUploadInput")
          .addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file || !selectedDate) {
              alert("请先选择日期");
              e.target.value = "";
              return;
            }
            if (!confirm(`上传 ${file.name} 到 ${selectedDate}?`)) {
              e.target.value = "";
              return;
            }
            const fd = new FormData();
            fd.append("file", file);
            fd.append("date", selectedDate);
            try {
              const res = await fetchWithAuth(`${API}/segment/upload`, {
                method: "POST",
                body: fd,
              });
              const d = await res.json();
              if (d.error) throw new Error(d.error);
              alert("上传成功");
              loadSegments();
            } catch (err) {
              alert("上传失败: " + err.message);
            }
            e.target.value = "";
          });
      });

      function initApp() {
        loadFiles();
        startPolling();
      }

      // Load Files
      async function loadFiles() {
        try {
          const res = await fetchWithAuth(`${API}/files`);
          if (res.status === 401) return location.reload();
          const { files } = await res.json();

          const listEl = document.getElementById("fileList");
          const selectEl = document.getElementById("segmentDateSelect");
          const oldVal = selectEl.value;

          selectEl.innerHTML = '<option value="">选择日期</option>';
          files.forEach((f) => selectEl.add(new Option(f.date, f.date)));
          selectEl.value = oldVal;

          if (files.length === 0) {
            listEl.innerHTML = '<div class="empty">暂无数据</div>';
            return;
          }

          listEl.innerHTML = files
            .map(
              (f) => `
            <div class="file-item">
              <div class="file-item-header">
                <span class="file-item-date">${f.date}</span>
                <span class="file-item-tag ${f.infoFile ? "ok" : "warn"}">${f.infoFile ? "完整" : "缺Info"}</span>
              </div>
              <div class="file-item-actions">
                <button class="btn btn-sm" onclick="triggerAction('merge','${f.date}')">合并</button>
                <button class="btn btn-sm btn-primary" onclick="triggerAction('start','${f.date}')">编辑并合成</button>
              </div>
              ${f.hasVideo ? `<a class="file-item-download" href="/video/${f.date}/final_ranking.mp4" target="_blank">下载视频</a>` : ""}
            </div>
          `,
            )
            .join("");
        } catch (e) {
          console.error(e);
        }
      }

      // Load Segments
      async function loadSegments() {
        const date = document.getElementById("segmentDateSelect").value;
        selectedDate = date;
        const container = document.getElementById("segmentList");

        if (!date) {
          container.innerHTML = '<div class="empty">请选择日期</div>';
          return;
        }

        container.innerHTML = '<div class="empty">加载中...</div>';

        try {
          const res = await fetchWithAuth(`${API}/segments?date=${date}`);
          const { segments } = await res.json();

          if (!segments || segments.length === 0) {
            container.innerHTML = '<div class="empty">暂无分片</div>';
            return;
          }

          container.innerHTML = segments
            .map(
              (s) => `
            <div class="segment-item">
              <span class="segment-name" title="${s}">${s}</span>
              <div class="segment-actions">
                <a href="/video/${date}/segments/${s}" download title="下载">↓</a>
                <button onclick="openRepair('${s}')" title="重绘">↻</button>
              </div>
            </div>
          `,
            )
            .join("");
        } catch (e) {
          container.innerHTML =
            '<div class="empty" style="color:#c00;">加载失败</div>';
        }
      }

      // Actions
      function openRepair(filename) {
        repairTargetFile = filename;
        document.getElementById("repairTarget").textContent =
          `目标: ${filename}`;
        document.getElementById("repairDialog").showModal();
      }

      async function confirmRepair() {
        document.getElementById("repairDialog").close();
        if (!selectedDate || !repairTargetFile) return;

        let payload = { date: selectedDate, segmentName: repairTargetFile };
        const match = repairTargetFile.match(/rank_(new|main)_(\d+)\.mp4/);
        if (match) {
          payload.type = match[1];
          payload.rank = parseInt(match[2]);
          delete payload.segmentName;
        }

        try {
          const res = await fetchWithAuth(`${API}/synthesis/segment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const d = await res.json();
          if (d.error) throw new Error(d.error);
          alert("指令已发送");
        } catch (e) {
          alert("失败: " + e.message);
        }
      }

      async function triggerAction(action, date) {
        if (action === "start") {
          location.href = `/editor.html?date=${date}`;
          return;
        }

        const url = `${API}/synthesis/merge`;
        if (!confirm("确认合并?")) return;

        try {
          const res = await fetchWithAuth(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date }),
          });
          const d = await res.json();
          if (d.error) throw new Error(d.error);
        } catch (e) {
          alert("失败: " + e.message);
        }
      }

      async function uploadFiles() {
        const input = document.getElementById("fileInput");
        if (input.files.length === 0) return alert("请选择文件");

        const fd = new FormData();
        for (const f of input.files) fd.append("files", f);

        const btn = document.getElementById("uploadBtn");
        btn.textContent = "上传中...";
        btn.disabled = true;

        try {
          const res = await fetchWithAuth(`${API}/upload`, {
            method: "POST",
            body: fd,
          });
          if (!res.ok) throw new Error("上传失败");
          loadFiles();
          alert("上传成功");
          input.value = "";
        } catch (e) {
          alert(e.message);
        } finally {
          btn.textContent = "上传";
          btn.disabled = false;
        }
      }

      // Polling
      function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
          try {
            const res = await fetchWithAuth(`${API}/status`);
            if (res.status === 401) return;
            updateStatus(await res.json());
          } catch (e) {}
        }, 1000);
      }

      function updateStatus(s) {
        const badge = document.getElementById("statusBadge");
        const title = document.getElementById("statusTitle");
        const desc = document.getElementById("statusDesc");
        const bar = document.getElementById("progressBar");
        const step = document.getElementById("stepText");
        const pctText = document.getElementById("progressText");

        badge.className = "status-badge";

        if (s.status === "idle") {
          badge.textContent = "IDLE";
          title.textContent = "空闲";
          desc.textContent = "等待任务";
          bar.style.width = "0%";
          step.textContent = "无任务";
          pctText.textContent = "0%";
        } else {
          if (s.status === "processing") {
            badge.classList.add("running");
            badge.textContent = "运行中";
            title.textContent = "处理中";
          } else if (s.status === "completed") {
            badge.classList.add("done");
            badge.textContent = "完成";
            title.textContent = "已完成";
          } else {
            badge.classList.add("error");
            badge.textContent = "错误";
            title.textContent = "出错";
          }
          desc.textContent = s.targetDate ? `目标: ${s.targetDate}` : "";

          const pct =
            s.progress && s.progress.total
              ? Math.round((s.progress.current / s.progress.total) * 100)
              : 0;
          bar.style.width = `${pct}%`;
          pctText.textContent = `${pct}%`;
          step.textContent = s.step || "";
        }

        // Logs
        const logBox = document.getElementById("logContainer");
        if (s.logs && s.logs.length > 0) {
          const html = s.logs
            .map((l) => {
              const parts = l.split("] ");
              let time = "";
              let msg = l;
              if (parts.length > 1) {
                const t = parts[0].replace("[", "");
                if (t.includes("T")) time = t.split("T")[1].split(".")[0];
                msg = parts.slice(1).join("] ");
              }

              let cls = "";
              if (
                msg.includes("失败") ||
                msg.includes("error") ||
                msg.includes("Error")
              )
                cls = "log-error";
              else if (msg.includes("完成") || msg.includes("成功"))
                cls = "log-success";
              else if (msg.includes("跳过")) cls = "log-skip";
              else if (msg.includes("渲染") || msg.includes("下载"))
                cls = "log-info";

              return `<div class="log-line"><span class="log-time">${time}</span><span class="${cls}">${msg}</span></div>`;
            })
            .join("");

          if (logBox.dataset.hash !== html.length.toString()) {
            logBox.innerHTML = html;
            logBox.dataset.hash = html.length.toString();
            logBox.scrollTop = logBox.scrollHeight;
          }
        }
      }

      function clearLogs() {
        const logBox = document.getElementById("logContainer");
        logBox.innerHTML = '<div style="color:#666;">已清空</div>';
        logBox.dataset.hash = "";
      }
    </script>
  </body>
</html>
